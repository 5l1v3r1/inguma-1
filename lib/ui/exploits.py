##      exploits.py
#       
#       Copyright 2009 Hugo Teso <hugo.teso@gmail.com>
#       
#       This program is free software; you can redistribute it and/or modify
#       it under the terms of the GNU General Public License as published by
#       the Free Software Foundation; either version 2 of the License, or
#       (at your option) any later version.
#       
#       This program is distributed in the hope that it will be useful,
#       but WITHOUT ANY WARRANTY; without even the implied warranty of
#       MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#       GNU General Public License for more details.
#       
#       You should have received a copy of the GNU General Public License
#       along with this program; if not, write to the Free Software
#       Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
#       MA 02110-1301, USA.

import pygtk
import gtk, gobject

import csv

class Exploits:

    def __init__(self):
        # create a liststore with one string column to use as the model
        self.liststore = gtk.ListStore(int, str, str, str, str, str, str, str)

        self.modelfilter = self.liststore.filter_new()

        # create the TreeView
        self.treeview = gtk.TreeView()

        # create the TreeViewColumns to display the data
        self.treeview.columns = [None]*8
        self.treeview.columns[0] = gtk.TreeViewColumn('No.')
        self.treeview.columns[1] = gtk.TreeViewColumn('Path')
        self.treeview.columns[2] = gtk.TreeViewColumn('Description')
        self.treeview.columns[3] = gtk.TreeViewColumn('Date')
        self.treeview.columns[4] = gtk.TreeViewColumn('Author')
        self.treeview.columns[5] = gtk.TreeViewColumn('Platform')
        self.treeview.columns[6] = gtk.TreeViewColumn('Type')
        self.treeview.columns[7] = gtk.TreeViewColumn('Port')

        self.exploits_loaded = 0

#        # load exploits from csv
#        ifile  = open('data/exploits/files.csv', "rb")
#        reader = csv.reader(ifile, delimiter=';')
#        headerList = reader.next()
#
#        # add bug data
#        self.states = []
#        for line in reader:
#            self.liststore.append([ int(line[0]), line[1], line[2], line[3], line[4], line[5], line[6], line[7] ])
##            if not line[5] in self.states:
##                print "Adding button for: '", line[5], "'"
##                self.states.append(line[5])
#
#        self.show_states = self.states[:]
#        self.modelfilter.set_visible_func(self.visible_cb, self.show_states)
#
#        self.treeview.set_model(self.modelfilter)
#
#        for n in range(8):
#            # add columns to treeview
#            self.treeview.append_column(self.treeview.columns[n])
#            # create a CellRenderers to render the data
#            self.treeview.columns[n].cell = gtk.CellRendererText()
#            # add the cells to the columns
#            self.treeview.columns[n].pack_start(self.treeview.columns[n].cell, True)
#            # set the cell attributes to the appropriate liststore column
#            self.treeview.columns[n].set_attributes(
#                self.treeview.columns[n].cell, text=n)
#
#        # make treeview searchable
#        self.treeview.set_search_column(5)

        # make ui layout
        self.vbox = gtk.VBox()
        self.scrolledwindow = gtk.ScrolledWindow()
        self.bbox = gtk.HButtonBox()
        self.vbox.pack_start(self.bbox, False)
        self.vbox.pack_start(self.scrolledwindow)
#        # create toggle buttons to select filtering based on
#        # bug state and set buttons active
#        for state in self.states:
#            b = gtk.ToggleButton(state)
#            self.bbox.pack_start(b)
#            b.set_active(True)
#            b.connect('toggled', self.check_buttons)

        self.scrolledwindow.add(self.treeview)

    # visibility determined by state matching active toggle buttons
    def visible_cb(self, model, iter, data):
        return model.get_value(iter, 5) in data

    # build list of bug states to show and then refilter
    def check_buttons(self, tb):
        del self.show_states[:]
        for b in self.bbox.get_children():
            if b.get_active():
                self.show_states.append(b.get_label())
        self.modelfilter.refilter()
        return

    def get_widget(self):
        return self.vbox

    def load_exploits(self, gom):
        if self.exploits_loaded == 0:
            gom.echo( 'Loading Exploits DDBB...' , False)
            # load exploits from csv
            ifile  = open('data/exploits/files.csv', "rb")
            reader = csv.reader(ifile, delimiter=';')
            headerList = reader.next()
    
            # add bug data
            self.states = []
            for line in reader:
                self.liststore.append([ int(line[0]), line[1], line[2], line[3], line[4], line[5], line[6], line[7] ])
    #            if not line[5] in self.states:
    #                print "Adding button for: '", line[5], "'"
    #                self.states.append(line[5])
    
            self.show_states = self.states[:]
            self.modelfilter.set_visible_func(self.visible_cb, self.show_states)
    
            self.treeview.set_model(self.modelfilter)
    
            for n in range(8):
                # add columns to treeview
                self.treeview.append_column(self.treeview.columns[n])
                # create a CellRenderers to render the data
                self.treeview.columns[n].cell = gtk.CellRendererText()
                # add the cells to the columns
                self.treeview.columns[n].pack_start(self.treeview.columns[n].cell, True)
                # set the cell attributes to the appropriate liststore column
                self.treeview.columns[n].set_attributes(
                    self.treeview.columns[n].cell, text=n)
    
            # make treeview searchable
            self.treeview.set_search_column(5)
    
            self.exploits_loaded = 1
